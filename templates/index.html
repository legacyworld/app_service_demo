<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Service éšœå®³ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ ãƒ‡ãƒ¢ (V1/V2)</title>
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .result-container { max-height: 80vh; overflow-y: auto; }
        .row-item { margin-bottom: 5px; padding: 10px; border-radius: 5px; }
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚«ãƒ©ãƒ¼ã‚¯ãƒ©ã‚¹ */
        .bg-success-subtle { background-color: #d1e7dd; }
        .bg-warning-subtle { background-color: #fff3cd; }
        .bg-danger-subtle { background-color: #f8d7da; }
        .bg-info-subtle { background-color: #cff4fc; }
    </style>
</head>
<body>

<div class="container mt-4">
    <h1 class="text-center mb-4">
        App Service API å¿œç­”ãƒ‡ãƒ¢
        <span class="badge bg-primary fs-6" id="call-count">0</span>
    </h1>
    
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h5 class="card-title">ãƒ‡ãƒ¢æ¦‚è¦</h5>
            
            <div class="mb-3">
                <label class="form-label fw-bold">APIãƒãƒ¼ã‚¸ãƒ§ãƒ³é¸æŠ:</label>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="apiVersion" id="versionV1" value="v1" checked>
                    <label class="form-check-label" for="versionV1">V1 (å®‰å®š: å¸¸ã«æˆåŠŸ)</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="apiVersion" id="versionV2" value="v2">
                    <label class="form-check-label" for="versionV2">V2 (ä¸å®‰å®š: ç¢ºç‡çš„ãªé…å»¶/ã‚¨ãƒ©ãƒ¼)</label>
                </div>
                <p class="text-muted small mt-2">ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³: <span id="current-version">V2</span></p>
            </div>

            <p class="mb-0">APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ <code>/api/status</code> ã‚’2ç§’ã”ã¨ã«å‘¼ã³å‡ºã—ã¦ã„ã¾ã™ã€‚</p>
            <p class="mb-0">V2 ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç¢ºç‡: æˆåŠŸ (60%), é…å»¶ (30%), ã‚¨ãƒ©ãƒ¼ (10%)</p>
        </div>
        <div class="card-footer text-muted small">
            Commit: {{ GIT_COMMIT }} / Deploy ID: {{ DEPLOY_ID }}
        </div>
    </div>


    <div class="result-container border p-3 bg-white shadow-sm">
        <h5 class="mb-3">å‘¼ã³å‡ºã—å±¥æ­´</h5>
        <div id="results-list">
            <!-- çµæœãŒã“ã“ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
        </div>
    </div>
</div>

<script>
const resultsList = document.getElementById('results-list');
const callCountElement = document.getElementById('call-count');
const currentVersionElement = document.getElementById('current-version');
let callCount = 0;

// ãƒãƒ¼ã‚¸ãƒ§ãƒ³å¤‰æ›´ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
document.querySelectorAll('input[name="apiVersion"]').forEach(radio => {
    radio.addEventListener('change', (e) => {
        currentVersionElement.textContent = e.target.value.toUpperCase();
    });
});

// ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
function getSelectedVersion() {
    return document.querySelector('input[name="apiVersion"]:checked').value;
}

function formatTimestamp(tsMillis) {
    const date = new Date(tsMillis);
    return date.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit', second: '2-digit', fractionalSecondDigits: 3 });
}

async function callApi() {
    callCount++;
    callCountElement.textContent = callCount;
    
    const version = getSelectedVersion();
    // é¸æŠã•ã‚ŒãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦ä»˜ä¸
    const apiEndpoint = `/api/status?version=${version}`;

    const startFetchTime = performance.now();
    let response;

    try {
        response = await fetch(apiEndpoint);
        const endFetchTime = performance.now();
        
        let data;
        try {
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ãŒ204 (No Content) ãªã©ã®å ´åˆã¯JSONãƒ‘ãƒ¼ã‚¹ã‚’ã‚¹ã‚­ãƒƒãƒ—
            if (response.status !== 204) {
                data = await response.json();
            } else {
                data = {};
            }
        } catch (e) {
            // JSONãƒ‘ãƒ¼ã‚¹å¤±æ•—ã®å ´åˆã‚‚ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦æ‰±ã†
            data = {
                outcome: "PARSE_ERROR",
                error: `Failed to parse response (Status: ${response.status})`,
                timestamp: Date.now(),
                latency_ms: (endFetchTime - startFetchTime).toFixed(2),
                version: version
            };
        }

        const statusCode = response.status;
        const outcome = data.outcome || (statusCode === 200 ? "OK" : "HTTP_ERROR");
        const serverLatencyMs = parseFloat(data.latency_ms || 0); 
        const totalLatencyMs = (endFetchTime - startFetchTime); 

        let bgColorClass;
        let icon;
        let outcomeBadgeClass;

        if (statusCode === 200) {
            if (outcome === 'SUCCESS') {
                bgColorClass = 'bg-success-subtle';
                icon = 'âœ…';
                outcomeBadgeClass = 'text-bg-success';
            } else if (outcome === 'LATENCY') {
                bgColorClass = 'bg-warning-subtle';
                icon = 'âš ï¸';
                outcomeBadgeClass = 'text-bg-warning';
            } else {
                bgColorClass = 'bg-info-subtle';
                icon = 'â“';
                outcomeBadgeClass = 'text-bg-info';
            }
        } else if (statusCode >= 500) {
            bgColorClass = 'bg-danger-subtle';
            icon = 'âŒ';
            outcomeBadgeClass = 'text-bg-danger';
        } else {
            // 4xxç³»
            bgColorClass = 'bg-warning-subtle';
            icon = 'ğŸ›‘';
            outcomeBadgeClass = 'text-bg-secondary';
        }

        // V2ã§ç™ºç”Ÿã™ã‚‹ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è©³ç´°ã«è¡¨ç¤º
        const detailMessage = data.message || data.error || `HTTP Status ${statusCode} (${outcome})`;
        const responseVersion = data.version ? `V${data.version.toUpperCase()}` : 'V?';

        // â˜…â˜…â˜… ä¿®æ­£ãƒ»å®Œæˆéƒ¨åˆ† â˜…â˜…â˜…
        const newItem = `
            <div class="row-item ${bgColorClass} d-flex justify-content-between align-items-center">
                <div>
                    <span class="fw-bold me-2">${icon} #${callCount}</span>
                    <span class="badge bg-dark me-2">HTTP ${statusCode}</span>
                    <span class="badge ${outcomeBadgeClass} me-2">${outcome}</span>
                    <span class="badge text-bg-primary me-2">${responseVersion}</span>
                    <span class="text-muted">${formatTimestamp(data.timestamp || Date.now())}</span>
                    <br>
                    <small class="text-break">${detailMessage}</small>
                </div>
                <div class="text-end">
                    <span class="fw-bold">${totalLatencyMs.toFixed(0)} ms</span>
                    <br>
                    <small>(Server: ${serverLatencyMs.toFixed(0)} ms)</small>
                </div>
            </div>
        `;
        // â˜…â˜…â˜… ä¿®æ­£ãƒ»å®Œæˆéƒ¨åˆ† ã“ã“ã¾ã§ â˜…â˜…â˜…
        
        resultsList.insertAdjacentHTML('afterbegin', newItem);
        
        // å±¥æ­´ãŒå¤šããªã£ãŸã‚‰å¤ã„ã‚‚ã®ã‚’å‰Šé™¤ (ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç¶­æŒã®ãŸã‚)
        while (resultsList.children.length > 50) {
            resultsList.removeChild(resultsList.lastChild);
        }

    } catch (error) {
        console.error('Fetch error:', error);
        
        // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ¬ãƒ™ãƒ«ã®å¤±æ•—
        const newItem = `
            <div class="row-item bg-dark text-white d-flex justify-content-between align-items-center">
                <div>
                    <span class="fw-bold me-2">ğŸš¨ #${callCount}</span>
                    <span class="badge bg-danger me-2">NETWORK FAILED</span>
                    <span class="badge text-bg-primary me-2">V${version.toUpperCase()}</span>
                    <br>
                    <small>ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§APIå‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ (${error.message})</small>
                </div>
                <div>
                    ${formatTimestamp(Date.now())}
                </div>
            </div>
        `;
        resultsList.insertAdjacentHTML('afterbegin', newItem);
    }
}

// 2000ms (2ç§’)ã”ã¨ã«APIã‚’å‘¼ã³å‡ºã™
setInterval(callApi, 2000);
callApi(); // æœ€åˆã«ä¸€åº¦ã™ãã«å®Ÿè¡Œ
</script>

</body>
</html>